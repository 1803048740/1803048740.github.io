---
title: PLSQL触发器
top_img: 
categories: 
- ETL工程师
- PLSQL
tags:
- 触发器
---

# PLSQL触发器

**现有如下题目：**

有表student(s_no, s_name, s_age, s_grade)，其中s_no-学号，也是主键，是从1开始向上排的
（例如：第一个学生学号是1，第二个是2，一次类推）；s_name-学生姓名；s_age-学生年龄；s_grade-年级；
这张表的数据量有几千万甚至上亿。一个学年结束了，我要让这些学生全部升一年级，即，让s_grade字段加1。
这条sql，写出来如下：
update student set s_grade=s_grade+1;
但是我们直接运行这条sql，会因数据量太大会把数据库undo表空间撑爆，从而发生异常。
那我们来写个存储过程，进行批量更新，我们每10万条提交一次。

```plsql
create or replace procedure pro_student is
  zongrenshu number;
  xuehao number :=0;
begin
  select count(1) into zongrenshu from student;--统计学员总人数
  while xuehao < zongrenshu loop
    xuehao := xuehao + 1;
    update student set s_grade=s_grade+1 where s_no = xuehao;--每次循环更新一条数据
    if mod(xuehao,100000) = 0 then commit;---每10W条提交一次
    end if;
  end loop;
  commit;---把最后不足10W条的数据提交
end;
```



----------------------------------------------------------------------------------------
> 触发器 trigger
>

## 一、概念

> 触发器是一个pl/sql块，类似存储过程和函数，是很多关系型数据库都提供的功能
>

### 1、触发器与存储过程/函数的区别

- 存储过程和函数创建之后，想要使用用户主动必须调用，触发器通过提前定义一个事件，当事件执行，自动触发
- 存储过程和函数都可以传递参数，而触发器不可以

### 2、触发器的作用

监控对数据库的各种操作，从而实现审计工作

## 二. 触发器的组成部分

1.触发`事件`  通常为DML语句的增删改，对表或视图进行操作的事件
2.触发`时间`  before 或 after 
3.触发`操作`  begin end 中写的内容
4.触发`对象`  表，视图，数据库
5.触发`频率`  表级与行级
            表级 ：针对一张表的操作只触发一次，为默认等级
            行级 ： for each row   针对于每一行数据的操作都会触发



## 三. 触发器的分类

1. DML触发器：  针对表的DML操作所创建的触发器
2. 替代触发器： 针对视图
3. 系统触发器： 针对数据库的登入登出，启动关闭等情况



## 四. 语法

### 1.DML 触发器

`create or replace trigger` 触发器名
`before/after`  ---在代码运行之前触发还是之后
`insert or update or delete` ---or 是记录多种操作时起连接作用的
`on` 表名
`for each row` --行级触发器，不写默认表级触发器
`begin`
  触发后要执行的操作;
`end`;



例题：
创建一个触发器，当我们删除empa表中的数据时，打印'检测到目标被修改'

```plsql
create or replace trigger tri_xiugai
  after delete on empa
  for each row
begin
  dbms_output.put_line('检测到目标被修改');
end;

--drop table empa;
--create table empa as select * from emp;
select * from empa;
delete from empa;
```


例题：
创建一个触发器，当我们删除empa表中的数据时，打印'检测到目标被删除'，
                      修改empa表中的数据时，打印'检测到目标被修改'，
                        给empa表插入数据时，打印'检测到目标被添加'，

> **属性：** 
>
> ==inserting==
>
> ==updating==
>
> ==deleting==

```plsql
create or replace trigger tri_xiugai
  after delete or update or insert on empa
  for each row
begin
  if deleting then 
  dbms_output.put_line('检测到目标被删除');
  elsif  updating  then 
    dbms_output.put_line('检测到目标被修改');
  elsif  inserting  then 
    dbms_output.put_line('检测到目标被添加');
  end if;
end;

delete from empa where ename = 'SMITH';
update empa set deptno = 40 where ename = 'SCOTT';
insert into empa(ename) values('罗语萱');
```

> **参数：**
>
> 只针对列名起作用
>
> ==:old== 旧数据 ，原数据
>
> ==:new== 新数据



例：创建一个触发器，当修改数据时，打印原数据为XXX，修改后的数据为XXX

```plsql
create or replace trigger tri_xiugai
  after update on empa
  for each row
begin
  if 
  dbms_output.put_line('原数据为:'||:old||'修改后的数据为:'||:new);
end;
```

